---
title: "Apache Camel Ã— AI â€• ã‚µãƒ¼ãƒ“ãƒ³ã‚°ã«ã‚ˆã‚‹æ¨è«– #3: KServe"
emoji: "ğŸª"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["ai", "æ©Ÿæ¢°å­¦ç¿’", "kubeflow", "camel", "mlops"]
published: false
---
![Camel AI](https://storage.googleapis.com/zenn-user-upload/2f89c845b33c-20250210.jpg =300x)

[å‰å›](https://zenn.dev/tadayosi/articles/6e168e1e752e43)ã€[å‰ã€…å›](https://zenn.dev/tadayosi/articles/69933eb96d6f68)ã®è¨˜äº‹ã§ã‚‚ç´¹ä»‹ã—ãŸé€šã‚Šã€å…ˆæ—¥ãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸ[Apache Camel 4.10 LTS](https://camel.apache.org/blog/2025/02/camel410-whatsnew/)ã§ã¯AIãƒ¢ãƒ‡ãƒ«ã‚µãƒ¼ãƒ“ãƒ³ã‚°ã«é–¢ã™ã‚‹3ã¤ã®æ–°ã—ã„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚[^1]

[^1]: Camel TorchServeã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯4.9ã‹ã‚‰ã€‚

* [TorchServeã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ](https://camel.apache.org/components/next/torchserve-component.html)
* [TensorFlow Servingã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ](https://camel.apache.org/components/next/tensorflow-serving-component.html)
* [KServeã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ](https://camel.apache.org/components/next/kserve-component.html)

ã“ã‚Œã¾ã§TorchServeã€TensorFlow Servingã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç´¹ä»‹ã—ã¾ã—ãŸï¼ˆ[è¨˜äº‹1](https://zenn.dev/tadayosi/articles/69933eb96d6f68)ã€[è¨˜äº‹2](https://zenn.dev/tadayosi/articles/6e168e1e752e43)ï¼‰ã€‚ä»Šå›ã¯KServeã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

## KServeã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

[KServe](https://kserve.github.io/website/)ã¯ã€Kubernetesä¸Šã§AIãƒ¢ãƒ‡ãƒ«ã‚’ã‚µãƒ¼ãƒ“ãƒ³ã‚°ã™ã‚‹ãŸã‚ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã™ã€‚KServeã«ã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ãƒ¢ãƒ‡ãƒ«ã‚µãƒ¼ãƒãƒ¼ã«ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãƒ»ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»æ¨è«–ã‚’è¡Œã†ãŸã‚ã®APIãƒ—ãƒ­ãƒˆã‚³ãƒ«ãŒå®šç¾©ã•ã‚Œã¦ãŠã‚Šã€ãã®KServe API [^2] ã‚’é€šã—ã¦KServeã«æº–æ‹ ã—ãŸãƒ¢ãƒ‡ãƒ«ã‚µãƒ¼ãƒãƒ¼ã‚’çµ±ä¸€çš„ã«å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚[Camel KServe](https://camel.apache.org/components/next/kserve-component.html)ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€Camelãƒ«ãƒ¼ãƒˆã‹ã‚‰KServe APIã‚’ä»‹ã—ã¦ãƒ¢ãƒ‡ãƒ«ã‚µãƒ¼ãƒãƒ¼ã¸æ¨è«–ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãã¾ã™ã€‚

[^2]: [KServe Open Inference Protocol V2](https://kserve.github.io/website/latest/modelserving/data_plane/v2_protocol/)

## æº–å‚™

æ”¹ã‚ã¦ã€ã¾ã [Camel CLI](https://camel.apache.org/manual/camel-jbang.html)ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã‘ã‚Œã°ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚

:::message
JBangãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€ã¾ãšã“ã¡ã‚‰ã‚’å‚è€ƒã«JBangã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚
https://www.jbang.dev/download/
:::

```console
jbang app install camel@apache/camel
```

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ããŸã‹å‹•ä½œç¢ºèªã‚’ã—ã¾ã™ã€‚

```console
$ camel --version
4.10.2
```

### ãƒ¢ãƒ‡ãƒ«ã®æº–å‚™ã¨ã‚µãƒ¼ãƒãƒ¼ç«‹ã¡ä¸Šã’

KServeã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’è©¦ã™ã«ã¯ã€[KServe Open Inference Protocol V2](https://kserve.github.io/website/latest/modelserving/data_plane/v2_protocol/)ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚µãƒ¼ãƒãƒ¼ãŒå¿…è¦ã§ã™ã€‚[OpenVINO](https://docs.openvino.ai/)ã‚„[Triton](https://docs.nvidia.com/deeplearning/triton-inference-server/user-guide/docs/index.html)ãªã©ã€ã„ãã¤ã‹ã®ãƒ¢ãƒ‡ãƒ«ã‚µãƒ¼ãƒãƒ¼ãŒåˆ©ç”¨ã§ãã¾ã™ã€‚ã“ã®è¨˜äº‹ã§ã¯ã€[Triton Inference Serverã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸](https://docs.nvidia.com/deeplearning/triton-inference-server/user-guide/docs/getting_started/quickstart.html)ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚Triton Inference Serverã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯ã€`amd64`ã ã‘ã§ãªã`arm64`ã«ã‚‚å¯¾å¿œã—ã¦ã„ã‚‹ãŸã‚ã€macOSãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚ç°¡å˜ã«è©¦ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

KServe APIã«ã¯ãƒ¢ãƒ‡ãƒ«ã‚’ç™»éŒ²ã™ã‚‹æ“ä½œã¯ãªã„ãŸã‚ã€ã‚µãƒ¼ãƒãƒ¼èµ·å‹•æ™‚ã«äºˆã‚ãƒ¢ãƒ‡ãƒ«ã‚‚ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚æœ¬è¨˜äº‹ã§ã¯ã€Triton Inference Serverã®ãƒªãƒã‚¸ãƒˆãƒªã§æä¾›ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¢ç”¨ã®[ãƒ¢ãƒ‡ãƒ«`simple`](https://github.com/triton-inference-server/server/tree/main/docs/examples/model_repository/simple)ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ã“ã®ãƒ¢ãƒ‡ãƒ«ã®è©³ç´°ã¯ã€å¾Œè¿°ã®ã€Œ[æ¨è«–](#æ¨è«–)ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§èª¬æ˜ã—ã¾ã™ã€‚

Triton Inference Serverãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰[simple](https://github.com/triton-inference-server/server/tree/main/docs/examples/model_repository/simple)ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä¸¸ã”ã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€ãã‚Œã‚’`models`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä¸‹ã«ç½®ã„ã¦ãã ã•ã„ã€‚

:::message
GitHubãƒªãƒã‚¸ãƒˆãƒªã®ç‰¹å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã¾ã¨ã‚ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã«ã¯ã€ãƒªãƒã‚¸ãƒˆãƒªã‚’ä¸¸ã”ã¨ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¦ã‚‚ã„ã„ã§ã™ãŒã€[VS Code for the Web](https://code.visualstudio.com/docs/editor/vscode-web)ã‚’ä½¿ã†ã®ãŒæœ€ã‚‚ç°¡å˜ã§ã™ã€‚GitHubãƒªãƒã‚¸ãƒˆãƒªã‚’è¡¨ç¤ºã—ãŸçŠ¶æ…‹ã§ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®ã€Œ`.`ã€ã‚’æŠ¼ã™ã‹URLã‚’`github.com`ã‹ã‚‰`github.dev`ã«æ›¸ãæ›ãˆã‚‹ã“ã¨ã§ã€ãã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã®VS Codeã§é–‹ã‘ã¾ã™ã€‚ãã®å¾Œã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¦‹ã¤ã‘ã¦å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€Œãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã‚’é¸æŠã—ã¾ã™ã€‚æ–°è¦ã«ä½œæˆã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’é¸æŠã™ã‚‹ã“ã¨ã§ã€ãã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã”ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚
:::

ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸ`simple`ã‚’`models`ã®ä¸‹ã«ç½®ã„ãŸã‚‰ã€`models`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒã‚ã‚‹å ´æ‰€ã‹ã‚‰ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚³ãƒ³ãƒ†ãƒŠãƒ¼ã‚’èµ·å‹•ã—ã¾ã™ã€‚

```console
docker run --rm --name triton \
    -p 8000:8000 \
    -p 8001:8001 \
    -p 8002:8002 \
    -v ./models:/models \
    nvcr.io/nvidia/tritonserver:25.02-py3 \
    tritonserver --model-repository=/models
```

:::message
Triton Inference Serverã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸`nvcr.io/nvidia/tritonserver`ã¯éå¸¸ã«å¤§ãã„ï¼ˆç´„18.2GBï¼‰ãŸã‚ã€åˆå›ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒ«ã™ã‚‹ã®ã«æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚
:::

## ã‚µãƒ¼ãƒãƒ¼ï¼ãƒ¢ãƒ‡ãƒ«ã¸ã®ç®¡ç†ç³»æ“ä½œ

:::message
Camel KServeã‚’ä½¿ã£ãŸæ¨è«–ã®æ–¹æ³•ã ã‘ã‚’æ‰‹æ—©ãçŸ¥ã‚ŠãŸã„æ–¹ã¯ã€ã“ã“ã‚’é£›ã°ã—ã¦[æ¨è«–](#æ¨è«–)ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰èª­ã‚“ã§ã‚‚çµæ§‹ã§ã™ã€‚
:::

KServe Open Protocol V2ãŒå®šç¾©ã™ã‚‹æ¨è«–ä»¥å¤–ã®ç®¡ç†ç³»æ“ä½œã¯å¤§ãã2ã¤ã«åˆ†ã‹ã‚Œã¾ã™ã€‚

1. ã‚µãƒ¼ãƒãƒ¼ã¸ã®æ“ä½œ
    * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯ï¼æ­»æ´»ç¢ºèªï¼ˆ[Server Ready](https://kserve.github.io/website/latest/modelserving/data_plane/v2_protocol/#server-ready) / [Server Live](https://kserve.github.io/website/latest/modelserving/data_plane/v2_protocol/#server-live) APIï¼‰
    * ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆ[Server Metadata](https://kserve.github.io/website/latest/modelserving/data_plane/v2_protocol/#server-metadata) APIï¼‰
2. ãƒ¢ãƒ‡ãƒ«ã¸ã®æ“ä½œ
    * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆ[Model Ready](https://kserve.github.io/website/latest/modelserving/data_plane/v2_protocol/#model-ready) APIï¼‰
    * ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆ[Model Metadata](https://kserve.github.io/website/latest/modelserving/data_plane/v2_protocol/#model-metadata) APIï¼‰

ãã‚Œãã‚ŒCamelãƒ«ãƒ¼ãƒˆã‹ã‚‰ã©ã†ã‚„ã£ã¦å‘¼ã³å‡ºã›ã‚‹ã‹ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

### ã‚µãƒ¼ãƒãƒ¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯

Camelãƒ«ãƒ¼ãƒˆã‹ã‚‰ã€ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—æº–å‚™ãŒã§ãã¦ã„ã‚‹ã‹ã‚’æ¬¡ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ç¢ºèªã§ãã¾ã™ã€‚

```uri
kserve:server/ready
```

```java:server_ready.java
//DEPS org.apache.camel:camel-bom:4.10.2@pom
//DEPS org.apache.camel:camel-core
//DEPS org.apache.camel:camel-kserve

import org.apache.camel.builder.RouteBuilder;

public class server_ready extends RouteBuilder {
    @Override
    public void configure() throws Exception {
        from("timer:server-ready?repeatCount=1")
            .to("kserve:server/ready")
            .log("Ready: ${body.ready}");
    }
}
```

Camel CLIã‹ã‚‰ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè¡Œã—ã¾ã™ã€‚

```console
camel run server_ready.java
```

æˆåŠŸã™ã‚Œã°ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚µãƒ¼ãƒãƒ¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèªã§ãã¾ã™ã€‚

```console
Ready: true
```

### ã‚µãƒ¼ãƒãƒ¼ã®æ­»æ´»ç¢ºèª

Camelãƒ«ãƒ¼ãƒˆã‹ã‚‰ã‚µãƒ¼ãƒãƒ¼ãŒç¨¼åƒã—ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ã«ã¯ã€æ¬¡ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ã„ã¾ã™ã€‚

```uri
kserve:server/live
```

```java:server_live.java
//DEPS org.apache.camel:camel-bom:4.10.2@pom
//DEPS org.apache.camel:camel-core
//DEPS org.apache.camel:camel-kserve

import org.apache.camel.builder.RouteBuilder;

public class server_live extends RouteBuilder {
    @Override
    public void configure() throws Exception {
        from("timer:server-live?repeatCount=1")
            .to("kserve:server/live")
            .log("Live: ${body.live}");
    }
}
```

Camel CLIã‹ã‚‰ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè¡Œã—ã¾ã™ã€‚

```console
camel run server_live.java
```

æˆåŠŸã™ã‚Œã°ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚µãƒ¼ãƒãƒ¼ã®æ­»æ´»çŠ¶æ…‹ã‚’ç¢ºèªã§ãã¾ã™ã€‚

```console
Live: true
```

### ã‚µãƒ¼ãƒãƒ¼ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—

Camelãƒ«ãƒ¼ãƒˆã‹ã‚‰ã‚µãƒ¼ãƒãƒ¼ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã«ã¯ã€æ¬¡ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ã„ã¾ã™ã€‚

```uri
kserve:server/metadata
```

```java:server_metadata.java
//DEPS org.apache.camel:camel-bom:4.10.2@pom
//DEPS org.apache.camel:camel-core
//DEPS org.apache.camel:camel-kserve

import org.apache.camel.builder.RouteBuilder;

public class server_metadata extends RouteBuilder {
    @Override
    public void configure() throws Exception {
        from("timer:server-metadata?repeatCount=1")
            .to("kserve:server/metadata")
            .log("Metadata:\n${body}");
    }
}
```

Camel CLIã‹ã‚‰ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè¡Œã—ã¾ã™ã€‚

```console
camel run server_metadata.java
```

æˆåŠŸã™ã‚Œã°ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚µãƒ¼ãƒãƒ¼ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã™ã€‚

```console
Metadata:
name: "triton"
version: "2.55.0"
extensions: "classification"
extensions: "sequence"
extensions: "model_repository"
extensions: "model_repository(unload_dependents)"
extensions: "schedule_policy"
extensions: "model_configuration"
extensions: "system_shared_memory"
extensions: "cuda_shared_memory"
extensions: "binary_tensor_data"
extensions: "parameters"
extensions: "statistics"
extensions: "trace"
extensions: "logging"
```

### ãƒ¢ãƒ‡ãƒ«ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯

ãƒ¢ãƒ‡ãƒ«ãŒæ¨è«–å¯èƒ½ãªçŠ¶æ…‹ã«ã‚ã‚‹ã‹ã©ã†ã‹ã‚’ã€æ¬¡ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ç¢ºèªã§ãã¾ã™ã€‚

```uri
kserve:model/ready?modelName=simple&modelVersion=1
```

```java:model_ready.java
//DEPS org.apache.camel:camel-bom:4.10.2@pom
//DEPS org.apache.camel:camel-core
//DEPS org.apache.camel:camel-kserve

import org.apache.camel.builder.RouteBuilder;

public class model_ready extends RouteBuilder {
    @Override
    public void configure() throws Exception {
        from("timer:model-ready?repeatCount=1")
            .to("kserve:model/ready?modelName=simple&modelVersion=1")
            .log("Ready: ${body.ready}");
    }
}
```

Camel CLIã‹ã‚‰ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè¡Œã—ã¾ã™ã€‚

```console
camel run model_ready.java
```

æˆåŠŸã™ã‚Œã°ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ¢ãƒ‡ãƒ«ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèªã§ãã¾ã™ã€‚

```console
Ready: true
```

### ãƒ¢ãƒ‡ãƒ«ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—

ã“ã‚Œã¾ã§è¦‹ã¦ããŸTorchServeã‚„TensorFlow Servingã¨åŒæ§˜ã€AIãƒ¢ãƒ‡ãƒ«ã‚’å‘¼ã³å‡ºã™ã«ã¯ãã®å…¥å‡ºåŠ›ã®ã‚·ã‚°ãƒãƒãƒ£ãƒ¼ã‚’ç†è§£ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚ãã®ãŸã‚ã«ã€ãƒ¢ãƒ‡ãƒ«ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã®ã¯ä¸€åº¦ã ã‘ã§ã„ã„ã®ã§ã€é€šå¸¸ã¯æ¬¡ã®REST APIã‚’ç›´æ¥å‘¼ã³å‡ºã—ã¦JSONå½¢å¼ã§ãƒ¢ãƒ‡ãƒ«ã‚·ã‚°ãƒãƒãƒ£ãƒ¼ã‚’ç¢ºèªã—ã¾ã™ï¼ˆ`simple`ãƒ¢ãƒ‡ãƒ«ã®å ´åˆï¼‰ã€‚

<http://localhost:8000/v2/models/simple/versions/1>

Camelãƒ«ãƒ¼ãƒˆã‹ã‚‰ãƒ¢ãƒ‡ãƒ«ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã™ã‚‹ã«ã¯ã€æ¬¡ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ã„ã¾ã™ã€‚

```uri
kserve:model/metadata?modelName=simple&modelVersion=1
```

```java:model_metadata.java
//DEPS org.apache.camel:camel-bom:4.10.2@pom
//DEPS org.apache.camel:camel-core
//DEPS org.apache.camel:camel-kserve

import org.apache.camel.builder.RouteBuilder;

public class model_metadata extends RouteBuilder {
    @Override
    public void configure() throws Exception {
        from("timer:model-metadata?repeatCount=1")
            .to("kserve:model/metadata?modelName=simple&modelVersion=1")
            .log("Metadata:\n${body}");
    }
}
```

Camel CLIã‹ã‚‰ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè¡Œã—ã¾ã™ã€‚

```console
camel run model_metadata.java
```

æˆåŠŸã™ã‚Œã°ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ¢ãƒ‡ãƒ«ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã™ã€‚

```console
Metadata:
name: "simple"
versions: "1"
platform: "tensorflow_graphdef"
inputs {
  name: "INPUT0"
  datatype: "INT32"
  shape: -1
  shape: 16
}
inputs {
  name: "INPUT1"
  datatype: "INT32"
  shape: -1
  shape: 16
}
outputs {
  name: "OUTPUT0"
  datatype: "INT32"
  shape: -1
  shape: 16
}
outputs {
  name: "OUTPUT1"
  datatype: "INT32"
  shape: -1
  shape: 16
}
```

## æ¨è«–

KServeã§ãƒ¢ãƒ‡ãƒ«ã‚’å‘¼ã³å‡ºã—ã¦æ¨è«–ã‚’ã•ã›ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã“ã“ã§ã¯ã€`simple`ãƒ¢ãƒ‡ãƒ«ã‚’å‘¼ã³å‡ºã—ã¦éå¸¸ã«ç°¡å˜ãªè¨ˆç®—ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

ã€Œ[ãƒ¢ãƒ‡ãƒ«ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—](#ãƒ¢ãƒ‡ãƒ«ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—)ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ç¢ºèªã—ãŸã‚ˆã†ã«ã€`simple` ãƒ¢ãƒ‡ãƒ«ã¯ã‚µã‚¤ã‚º16ã®2ã¤ã®`INT32`ãƒªã‚¹ãƒˆï¼ˆ`INPUT0`ã¨`INPUT1`ï¼‰ã‚’å…¥åŠ›ã¨ã—ã¦å—ã‘å–ã‚Šã€ã‚µã‚¤ã‚º16ã®2ã¤ã®`INT32`ãƒªã‚¹ãƒˆã‚’å‡ºåŠ›ï¼ˆ`OUTPUT0`ã¨`OUTPUT1`ï¼‰ã¨ã—ã¦è¿”ã—ã¾ã™ã€‚ã“ã®ãƒ¢ãƒ‡ãƒ«ã¯å˜ç´”ã«ã€`INPUT0`ã¨`INPUT1`ã®å„è¦ç´ ã‚’åŠ ç®—ã—ãŸçµæœã‚’`OUTPUT0`ã¨ã—ã¦ã€`INPUT0`ã¨`INPUT1`ã®å„è¦ç´ ã‚’æ¸›ç®—ã—ãŸçµæœã‚’`OUTPUT1`ã¨ã—ã¦è¿”ã—ã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã§ã¯ã€æ¬¡ã®å…¥åŠ›ã‚’ãƒ¢ãƒ‡ãƒ«ã«ä¸ãˆã¾ã™ã€‚

```console
INPUT0  = [1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16]
INPUT1  = [0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15]
```

ãã—ã¦åŒæ§˜ã«ã€æ¬¡ã®å‡ºåŠ›ã‚’çµæœã¨ã—ã¦å—ã‘å–ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

```console
OUTPUT0 = [1,  3,  5,  7,  9, 11, 13, 15, 17, 19, 21, 23, 25, 27, 29, 31]
OUTPUT1 = [1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1]
```

![Simpleãƒ¢ãƒ‡ãƒ«ã®å‘¼ã³å‡ºã—](/images/camel-ai-kserve/infer-simple.png)
*Simpleãƒ¢ãƒ‡ãƒ«ã®å‘¼ã³å‡ºã—*

æ¨è«–ã«ã¯ä»¥ä¸‹ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ã„ã¾ã™ã€‚

```uri
kserve:infer?modelName=simple&modelVersion=1
```

```java:infer_simple.java
//DEPS org.apache.camel:camel-bom:4.10.2@pom
//DEPS org.apache.camel:camel-core
//DEPS org.apache.camel:camel-kserve

import java.nio.ByteOrder;
import java.util.ArrayList;
import java.util.stream.Collectors;
import java.util.stream.IntStream;
import org.apache.camel.Exchange;
import org.apache.camel.builder.RouteBuilder;
import com.google.protobuf.ByteString;
import inference.GrpcPredictV2.InferTensorContents;
import inference.GrpcPredictV2.ModelInferRequest;
import inference.GrpcPredictV2.ModelInferResponse;

public class infer_simple extends RouteBuilder {
    @Override
    public void configure() throws Exception {
        from("timer:infer-simple?repeatCount=1")
            .setBody(constant(createRequest()))
            .to("kserve:infer?modelName=simple&modelVersion=1")
            .process(this::postprocess)
            .log("Result[0]: ${body[0]}")
            .log("Result[1]: ${body[1]}");
    }

    ModelInferRequest createRequest() {
        var ints0 = IntStream.range(1, 17).boxed().collect(Collectors.toList());
        var content0 = InferTensorContents.newBuilder().addAllIntContents(ints0);
        var input0 = ModelInferRequest.InferInputTensor.newBuilder()
                .setName("INPUT0").setDatatype("INT32").addShape(1).addShape(16)
                .setContents(content0);
        var ints1 = IntStream.range(0, 16).boxed().collect(Collectors.toList());
        var content1 = InferTensorContents.newBuilder().addAllIntContents(ints1);
        var input1 = ModelInferRequest.InferInputTensor.newBuilder()
                .setName("INPUT1").setDatatype("INT32").addShape(1).addShape(16)
                .setContents(content1);
        return ModelInferRequest.newBuilder()
                .addInputs(0, input0).addInputs(1, input1)
                .build();
    }

    void postprocess(Exchange exchange) {
        var response = exchange.getMessage().getBody(ModelInferResponse.class);
        var outList = response.getRawOutputContentsList().stream()
                .map(ByteString::asReadOnlyByteBuffer)
                .map(buf -> buf.order(ByteOrder.LITTLE_ENDIAN).asIntBuffer())
                .map(buf -> {
                    var ints = new ArrayList<Integer>(buf.remaining());
                    while (buf.hasRemaining()) {
                        ints.add(buf.get());
                    }
                    return ints;
                })
                .collect(Collectors.toList());
        exchange.getMessage().setBody(outList);
    }
}
```

Camel CLIã‹ã‚‰ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè¡Œã—ã¾ã™ã€‚

```console
camel run infer_simple.java
```

æˆåŠŸã™ã‚Œã°ã€ä»¥ä¸‹ã®ã‚ˆã†ãªçµæœãŒå¾—ã‚‰ã‚Œã‚‹ã§ã—ã‚‡ã†ã€‚ä¸Šã§èª¬æ˜ã—ãŸé€šã‚Šã®è¨ˆç®—çµæœãŒå¾—ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

```console
Result[0]: [1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21, 23, 25, 27, 29, 31]
Result[1]: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
```

## ã¾ã¨ã‚

ã“ã‚Œã¾ã§ã€æœ€æ–°ã®Camel 4.10 LTSãƒªãƒªãƒ¼ã‚¹ã§è¿½åŠ ã•ã‚ŒãŸAIãƒ¢ãƒ‡ãƒ«ã‚µãƒ¼ãƒ“ãƒ³ã‚°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’3å›ã«ã‚ãŸã£ã¦ç´¹ä»‹ã—ã¦ãã¾ã—ãŸã€‚ä»Šå›ã®KServeã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§æœ€å¾Œã«ãªã‚Šã¾ã™ã€‚

TorchServeã€TensorFlow Servingã«åŠ ãˆã€KServeã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½¿ã†ã“ã¨ã§ã€ç¾åœ¨ä¸»æµã®AIãƒ¢ãƒ‡ãƒ«ã‚µãƒ¼ãƒãƒ¼ã®å¤§éƒ¨åˆ†ã‚’ã‚«ãƒãƒ¼ã§ãã‚‹ã§ã—ã‚‡ã†ã€‚Camel 4.10 LTSã§ã€Camelã¨ãƒ¢ãƒ‡ãƒ«ã‚µãƒ¼ãƒãƒ¼ã‚’çµ„ã¿åˆã‚ã›ã¦ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹æº–å‚™ãŒæ•´ã£ãŸã¨ã„ãˆã¾ã™ã€‚

KServeã¯ã•ã‚‰ã«ã€Kubernetesä¸Šã§MLOpsã‚’æ§‹ç¯‰ã™ã‚‹éš›ã®ãƒ¢ãƒ‡ãƒ«ã‚µãƒ¼ãƒ“ãƒ³ã‚°ã®ãƒ‡ãƒ•ã‚¡ã‚¯ãƒˆã«ãªã‚Šã¤ã¤ã‚ã‚‹APIã§ã™ã€‚Kubeflowãªã©ã®MLOpsãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ä¸Šã§æ§‹ç¯‰ã—ã¦ã„ã‚‹AIã‚·ã‚¹ãƒ†ãƒ ã«ã‚‚ã€AIãƒ¢ãƒ‡ãƒ«ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã¨ã—ã¦Camelã®ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ´»ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã¨ã„ã†ã“ã¨ã§ã™ã€‚

Apache CamelÃ—AIã‚’ä½¿ã£ã¦ã€ãœã²ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆãªã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è©¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

### ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰

ä»Šå›ç´¹ä»‹ã—ãŸCamelÃ—AIã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯ã€ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã§å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚

https://github.com/megacamelus/camel-ai-examples
