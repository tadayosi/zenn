---
title: "Apache Camel Ã— AI â€• ã‚µãƒ¼ãƒ“ãƒ³ã‚°ã«ã‚ˆã‚‹æ¨è«– #1: TorchServe"
emoji: "ğŸª"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["ai", "æ©Ÿæ¢°å­¦ç¿’", "tensorflow", "camel", "mlops"]
published: true
---
![Camel AI](https://storage.googleapis.com/zenn-user-upload/2f89c845b33c-20250210.jpg =300x)

[å‰å›ã®è¨˜äº‹](https://zenn.dev/tadayosi/articles/69933eb96d6f68)ã§ã‚‚ç´¹ä»‹ã—ãŸé€šã‚Šã€å…ˆæ—¥ãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸ[Apache Camel 4.10 LTS](https://camel.apache.org/blog/2025/02/RELEASE-4.10.0/)ã§ã¯AIãƒ¢ãƒ‡ãƒ«ã‚µãƒ¼ãƒ“ãƒ³ã‚°ã«é–¢ã™ã‚‹3ã¤ã®æ–°ã—ã„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚[^1]

[^1]: Camel TorchServeã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯4.9ã‹ã‚‰ã€‚

* [TorchServeã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ](https://camel.apache.org/components/next/torchserve-component.html)
* [TensorFlow Servingã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ](https://camel.apache.org/components/next/tensorflow-serving-component.html)
* [KServeã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ](https://camel.apache.org/components/next/kserve-component.html)

[å‰å›](https://zenn.dev/tadayosi/articles/69933eb96d6f68)ã¯TorchServeã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ã¤ã„ã¦æ›¸ã„ãŸã®ã§ã€ä»Šå›ã¯TensorFlow Servingã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã™ã€‚

## TensorFlow Servingã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

[TensorFlow Serving](https://www.tensorflow.org/tfx/guide/serving)ã¯æ©Ÿæ¢°å­¦ç¿’ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®TensorFlowãŒæä¾›ã™ã‚‹ã‚µãƒ¼ãƒ“ãƒ³ã‚°æ©Ÿèƒ½ã§ã™ã€‚[Camel TensorFlow Serving](https://camel.apache.org/components/next/tensorflow-serving-component.html)ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½¿ã†ã“ã¨ã§ã€TensorFlow Servingã®[gRPC Client APIs](https://github.com/tensorflow/serving/blob/2.18.0/tensorflow_serving/apis/prediction_service.proto)ã‚’é€šã—ã¦TensorFlowãƒ¢ãƒ‡ãƒ«ã‚µãƒ¼ãƒãƒ¼ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹AIãƒ¢ãƒ‡ãƒ«ã‚’å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

## æº–å‚™

æ”¹ã‚ã¦ã€ã¾ã [Camel CLI](https://camel.apache.org/manual/camel-jbang.html)ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã‘ã‚Œã°ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚

:::message
JBangãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€ã¾ãšã“ã¡ã‚‰ã‚’å‚è€ƒã«JBangã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚
https://www.jbang.dev/download/
:::

```console
jbang app install camel@apache/camel
```

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ããŸã‹å‹•ä½œç¢ºèªã‚’ã—ã¾ã™ã€‚

```console
$ camel --version
4.10.0
```

### ãƒ¢ãƒ‡ãƒ«ã®æº–å‚™ã¨ã‚µãƒ¼ãƒãƒ¼ç«‹ã¡ä¸Šã’

æ¬¡ã«ã€TensorFlow Servingã®ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¡ä¸Šã’ã¾ã™ã€‚æœ€ã‚‚æ‰‹è»½ãªæ–¹æ³•ã¯[Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã†æ–¹æ³•](https://www.tensorflow.org/tfx/serving/docker)ã§ã™ãŒã€è¨˜äº‹åŸ·ç­†æ™‚ç‚¹ã§ã¯å…¬å¼ã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸`tensorflow/serving`ã¯`amd64`ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ã—ã‹å¯¾å¿œã—ã¦ã„ãªã„ãŸã‚ã€macOSãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚‚è©¦ã›ã‚‹ã‚ˆã†ã«`arm64`ã«ã‚‚å¯¾å¿œã—ã¦ã„ã‚‹[Bitnamiã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸](https://github.com/bitnami/containers/tree/main/bitnami/tensorflow-serving)ã‚’ä½¿ã†ã“ã¨ã«ã—ã¾ã™ã€‚

PyTorchã¨é•ã„ã€TensorFlow Servingã§ã¯ã‚µãƒ¼ãƒãƒ¼èµ·å‹•æ™‚ã«ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’äºˆã‚æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚æœ¬è¨˜äº‹ã§ã¯2ã¤ã®ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã„ã¾ã™ã€‚

- `half_plus_two`ï¼ˆ`x/2 + 2`ï¼‰ â‹¯ TensorFlow Servingã®ãƒªãƒã‚¸ãƒˆãƒªã«ã‚ã‚‹ãƒ†ã‚¹ãƒˆç”¨ãƒ¢ãƒ‡ãƒ«ï¼ˆ[testdata](https://github.com/tensorflow/serving/tree/master/tensorflow_serving/servables/tensorflow/testdata)ï¼‰
- `mnist` â‹¯ TensorFlowã§äºˆã‚å­¦ç¿’ã—ãŸMNISTã®ãƒ¢ãƒ‡ãƒ«

ç°¡ç•¥åŒ–ã®ãŸã‚ã«ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã®ãƒªãƒã‚¸ãƒˆãƒªã«ãã®ã¾ã¾ä½¿ãˆã‚‹ãƒ¢ãƒ‡ãƒ« [models](https://github.com/megacamelus/camel-ai-examples/tree/main/tensorflow-serving/models) ã‚’ç”¨æ„ã—ã¦ã„ã¾ã™ã®ã§ã€ã“ã¡ã‚‰ã‚’ç›´æ¥ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚

:::message
GitHubãƒªãƒã‚¸ãƒˆãƒªã®ç‰¹å®šãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã¾ã¨ã‚ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã«ã¯ã€ãƒªãƒã‚¸ãƒˆãƒªã‚’ä¸¸ã”ã¨ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¦ã‚‚ã„ã„ã§ã™ãŒã€[VS Code for the Web](https://code.visualstudio.com/docs/editor/vscode-web)ã‚’ä½¿ã†ã®ãŒæœ€ã‚‚ç°¡å˜ã§ã™ã€‚GitHubãƒªãƒã‚¸ãƒˆãƒªã‚’è¡¨ç¤ºã—ãŸçŠ¶æ…‹ã§ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®ã€Œ`.`ã€ã‚’æŠ¼ã™ã‹URLã‚’`github.com`ã‹ã‚‰`github.dev`ã«æ›¸ãæ›ãˆã‚‹ã“ã¨ã§ã€ãã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã®VS Codeã§é–‹ã‘ã¾ã™ã€‚ãã®å¾Œã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¦‹ã¤ã‘ã¦å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€Œãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã‚’é¸æŠã—ã¾ã™ã€‚æ–°è¦ã«ä½œæˆã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’é¸æŠã™ã‚‹ã“ã¨ã§ã€ãã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã”ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚
:::

`models`ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ããŸã‚‰ã€`models`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒã‚ã‚‹å ´æ‰€ã‹ã‚‰ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚³ãƒ³ãƒ†ãƒŠãƒ¼ã‚’èµ·å‹•ã—ã¾ã™ã€‚

```console
docker run --rm -it --name tf-serving \
    -p 8500:8500 -p 8501:8501 \
    -v ./models:/models \
    -v ./models/models.pbtxt:/bitnami/tensorflow-serving/conf/tensorflow-serving.conf \
    bitnami/tensorflow-serving
```

## ãƒ¢ãƒ‡ãƒ«ã®æ“ä½œ

:::message
Camelä¸Šã§TensorFlowãƒ¢ãƒ‡ãƒ«ã‚’æ“ä½œã™ã‚‹æ–¹æ³•ã«èˆˆå‘³ãŒãªã„æ–¹ã‚„ã€æ¨è«–ã®æ–¹æ³•ã ã‘ã‚’æ‰‹æ—©ãçŸ¥ã‚ŠãŸã„æ–¹ã¯ã€ã“ã“ã‚’é£›ã°ã—ã¦[æ¨è«–](#æ¨è«–)ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰èª­ã‚“ã§ã‚‚çµæ§‹ã§ã™ã€‚
:::

TensorFlow ServingãŒæä¾›ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ç®¡ç†ç³»ã®æ“ä½œã¯åŸºæœ¬çš„ã«2ã¤ã§ã™ã€‚

- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆ[Model status API](https://www.tensorflow.org/tfx/serving/api_rest#model_status_api)ï¼‰
- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆ[Model Metadata API](https://www.tensorflow.org/tfx/serving/api_rest#model_metadata_api)ï¼‰

ãã‚Œãã‚ŒCamelãƒ«ãƒ¼ãƒˆã‹ã‚‰ã©ã†ã‚„ã£ã¦å‘¼ã³å‡ºã›ã‚‹ã‹ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

### ãƒ¢ãƒ‡ãƒ«ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯

ã¾ãšã€ãƒ¢ãƒ‡ãƒ«ãŒæ¨è«–å¯èƒ½ãªçŠ¶æ…‹ã«ã‚ã‚‹ã‹ã©ã†ã‹ã‚’æ¬¡ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ç¢ºèªã§ãã¾ã™ã€‚MNISTãƒ¢ãƒ‡ãƒ«ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚

```uri
tensorflow-serving:model-status?modelName=mnist&modelVersion=1
```

```java:model_status.java
//DEPS org.apache.camel:camel-bom:4.10.0@pom
//DEPS org.apache.camel:camel-core
//DEPS org.apache.camel:camel-tensorflow-serving

import org.apache.camel.builder.RouteBuilder;

public class model_status extends RouteBuilder {
    @Override
    public void configure() throws Exception {
        from("timer:model-status?repeatCount=1")
            .to("tensorflow-serving:model-status?modelName=mnist&modelVersion=1")
            .log("Status: ${body.getModelVersionStatus(0).state}");
    }
}
```

Camel CLIã‹ã‚‰ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè¡Œã—ã¾ã™ã€‚

```console
camel run model_status.java
```

æˆåŠŸã™ã‚Œã°ã€ä»¥ä¸‹ã®ã‚ˆã†ã«MNISTãƒ¢ãƒ‡ãƒ«ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèªã§ãã¾ã™ã€‚

```console
Status: AVAILABLE
```

### ãƒ¢ãƒ‡ãƒ«ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—

TensorFlowã®ãƒ¢ãƒ‡ãƒ«ã‚’å‘¼ã³å‡ºã—ã¦æ¨è«–ã™ã‚‹ã«ã¯ã€ãƒ¢ãƒ‡ãƒ«ã®å…¥å‡ºåŠ›ã®ã‚·ã‚°ãƒãƒãƒ£ãƒ¼ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚

:::message
TensorFlowã§ã¯ã€å…¥å‡ºåŠ›ã®ãƒ†ãƒ³ã‚½ãƒ«ã®å½¢å¼ã‚’æ­£ç¢ºã«åˆã‚ã›ãªã„ã¨ã€ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ¢ãƒ‡ãƒ«ã«æ¸¡ã™ã“ã¨ã‚‚çµæœã‚’å—ã‘å–ã‚‹ã“ã¨ã‚‚ã§ãã¾ã›ã‚“ã€‚
:::

é€šå¸¸ã¯ã€ä»¥ä¸‹ã®[REST API](https://www.tensorflow.org/tfx/serving/api_rest#model_metadata_api)ã‚’å‘¼ã³å‡ºã—ã€JSONå½¢å¼ã§ãƒ¢ãƒ‡ãƒ«ã‚·ã‚°ãƒãƒãƒ£ãƒ¼ã‚’ç¢ºèªã—ã¾ã™ã€‚ï¼ˆ`mnist`ãƒ¢ãƒ‡ãƒ«ã®å ´åˆï¼‰

<http://localhost:8501/v1/models/mnist/metadata>

REST APIã‚’å©ã„ã¦ç¢ºèªã™ã‚‹ã®ã«æ¯”ã¹ã‚‹ã¨æœ‰ç”¨æ€§ã¯å°‘ãªã„ã¨æ€ã‚ã‚Œã¾ã™ãŒã€Camelãƒ«ãƒ¼ãƒˆã‹ã‚‰ã‚‚ãƒ¢ãƒ‡ãƒ«ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—å¯èƒ½ã§ã™ã€‚

```uri
tensorflow-serving:model-metadata?modelName=mnist&modelVersion=1
```

```java:model_metadata.java
//DEPS org.apache.camel:camel-bom:4.10.0@pom
//DEPS org.apache.camel:camel-core
//DEPS org.apache.camel:camel-tensorflow-serving

import org.apache.camel.builder.RouteBuilder;

public class model_metadata extends RouteBuilder {
    @Override
    public void configure() throws Exception {
        from("timer:model-metadata?repeatCount=1")
            .to("tensorflow-serving:model-metadata?modelName=mnist&modelVersion=1")
            .log("Metadata: ${body.getMetadataOrThrow('signature_def')}");
    }
}
```

Camel CLIã‹ã‚‰ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè¡Œã—ã¾ã™ã€‚

```console
camel run model_metadata.java
```

æˆåŠŸã™ã‚Œã°ã€ä»¥ä¸‹ã®ã‚ˆã†ã«MNISTãƒ¢ãƒ‡ãƒ«ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒå¾—ã‚‰ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

```console
Metadata: type_url: "type.googleapis.com/tensorflow.serving.SignatureDefMap"
value: "\n\245\001\n\005serve\022\233\001\n?\n\fkeras_tensor\022/\n\024serve_keras_tensor:0\020\001\032\025\022\v\b\377\377\377\377\377\377\377\377\377\001\022\002\b\034\022\002\b\034\022<\n\boutput_0\0220\n\031StatefulPartitionedCall:0\020\001\032\021\022\v\b\377\377\377\377\377\377\377\377\377\001\022\002\b\n\032\032tensorflow/serving/predict\n\273\001\n\017serving_default\022\247\001\nI\n\fkeras_tensor\0229\n\036serving_default_keras_tensor:0\020\001\032\025\022\v\b\377\377\377\377\377\377\377\377\377\001\022\002\b\034\022\002\b\034\022>\n\boutput_0\0222\n\033StatefulPartitionedCall_1:0\020\001\032\021\022\v\b\377\377\377\377\377\377\377\377\377\001\022\002\b\n\032\032tensorflow/serving/predict\n>\n\025__saved_model_init_op\022%\022#\n\025__saved_model_init_op\022\n\n\004NoOp\032\002\030\001"
```

## æ¨è«–

æœ¬é¡Œã®æ¨è«–ã§ã™ã€‚å®Ÿéš›ã®Camelãƒ«ãƒ¼ãƒˆã§ä¸»ã«ä½¿ã†ã®ã¯ã“ã®æ“ä½œï¼ˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰ã§ã™ã€‚TensorFlow Servingã«ã¯ã€æ¬¡ã®3ç¨®é¡ã®æ¨è«–APIãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚

- [Predict API](https://www.tensorflow.org/tfx/serving/api_rest#predict_api) â‹¯ æ±ç”¨ã®æ¨è«–API
- [Classify API](https://www.tensorflow.org/tfx/serving/api_rest#classify_and_regress_api) â‹¯ åˆ†é¡å•é¡Œã«ç‰¹åŒ–ã—ãŸæ¨è«–API
- [Regress API](https://www.tensorflow.org/tfx/serving/api_rest#classify_and_regress_api) â‹¯ å›å¸°åˆ†æã«ç‰¹åŒ–ã—ãŸæ¨è«–API

### æ±ç”¨ã®æ¨è«–ï¼ˆPredictï¼‰

ã¾ãšã¯æ±ç”¨ã®Predict APIã‹ã‚‰è¦‹ã¦ã„ãã¾ã™ã€‚ã“ã®APIã¯ç‰¹å®šã®å•é¡Œã«ã‚ˆã‚‰ãšã€ã©ã‚“ãªãƒ¢ãƒ‡ãƒ«ã§ã‚‚å‘¼ã³å‡ºã›ã¾ã™ã€‚ãã®ä»£ã‚ã‚Šã€ãƒ‡ãƒ¼ã‚¿å…¥å‡ºåŠ›ã®APIã‚‚æ±ç”¨ã«ãªã£ã¦ãŠã‚Šã€ãƒ‡ãƒ¼ã‚¿ã‚’é©åˆ‡ã«å¤‰æ›ã™ã‚‹ã¾ã§ãŒç…©é›‘ã§ã™ã€‚

æœ€åˆã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸMNISTãƒ¢ãƒ‡ãƒ«ã‚’ã“ã®Predict APIã‹ã‚‰å‘¼ã³å‡ºã—ã¦ã¿ã¾ã™ã€‚MNISTã¯ã€28x28ã®ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ã®æ‰‹æ›¸ãã®ç”»åƒã‚’æ•°å­—ã¨ã—ã¦èªè­˜ã•ã›ã‚‹ãƒ¢ãƒ‡ãƒ«ã§ã™ã€‚TorchServeã®ã¨ãã«ä½¿ã£ãŸåŒã˜[ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿](https://github.com/pytorch/serve/tree/master/examples/image_classifier/mnist/test_data)ã‚’ä»Šå›ã‚‚ä½¿ã„ã¾ã™ã€‚

![MNISTã«ã‚ˆã‚‹æ‰‹æ›¸ãæ•°å­—ã®èªè­˜](https://storage.googleapis.com/zenn-user-upload/a2fe9a20782c-20250219.png)
*MNISTã«ã‚ˆã‚‹æ‰‹æ›¸ãæ•°å­—ã®èªè­˜*

æ¨è«–ã«ã¯ä»¥ä¸‹ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ã„ã¾ã™ã€‚

```uri
tensorflow-serving:predict?modelName=mnist&modelVersion=1
```

```java:predict.java
//DEPS org.apache.camel:camel-bom:4.10.0@pom
//DEPS org.apache.camel:camel-core
//DEPS org.apache.camel:camel-tensorflow-serving

import java.awt.image.BufferedImage;
import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.IntStream;
import javax.imageio.ImageIO;
import org.apache.camel.Exchange;
import org.apache.camel.RuntimeCamelException;
import org.apache.camel.builder.RouteBuilder;
import org.tensorflow.framework.DataType;
import org.tensorflow.framework.TensorProto;
import org.tensorflow.framework.TensorShapeProto;
import org.tensorflow.framework.TensorShapeProto.Dim;
import com.google.protobuf.Int64Value;
import tensorflow.serving.Model.ModelSpec;
import tensorflow.serving.Predict.PredictRequest;
import tensorflow.serving.Predict.PredictResponse;

public class predict extends RouteBuilder {
    @Override
    public void configure() throws Exception {
        from("file:data?noop=true&recursive=true&include=.*\\.png")
            .process(this::toPredictRequest)   // (1)
            .to("tensorflow-serving:predict?modelName=mnist&modelVersion=1")
            .process(this::argmax)             // (2)
            .log("${headers.camelFileName} => ${body}");
    }

    void toPredictRequest(Exchange exchange) { // (3)
        byte[] body = exchange.getMessage().getBody(byte[].class);
        List<Float> data = preprocess(body);
        TensorProto inputs = TensorProto.newBuilder()
                .setDtype(DataType.DT_FLOAT)
                .setTensorShape(TensorShapeProto.newBuilder()
                        .addDim(Dim.newBuilder().setSize(28))
                        .addDim(Dim.newBuilder().setSize(28)))
                .addAllFloatVal(data)
                .build();
        PredictRequest request = PredictRequest.newBuilder()
                .putInputs("keras_tensor", inputs)
                .build();
        exchange.getMessage().setBody(request);
    }

    List<Float> preprocess(byte[] data) {      // (4)
        try {
            BufferedImage image = ImageIO.read(new ByteArrayInputStream(data));
            int width = image.getWidth();
            int height = image.getHeight();
            if (width != 28 || height != 28) {
                throw new RuntimeCamelException("Image size must be 28x28");
            }
            List<Float> normalised = new ArrayList<>(width * height);
            for (int y = 0; y < height; y++) {
                for (int x = 0; x < width; x++) {
                    int rgb = image.getRGB(x, y);
                    normalised.add((rgb & 0xFF) / 255.0f);
                }
            }
            return normalised;
        } catch (IOException e) {
            throw new RuntimeCamelException("Error reading image", e);
        }
    }

    void argmax(Exchange exchange) {           // (5)
        PredictResponse response = exchange.getMessage().getBody(PredictResponse.class);
        TensorProto tensor = response.getOutputsOrThrow("output_0");
        int result = IntStream.range(0, tensor.getFloatValCount())
                .reduce((max, i) -> tensor.getFloatVal(max) > tensor.getFloatVal(i) ? max : i)
                .orElseThrow();
        exchange.getMessage().setBody(result);
    }
}
```

ã‚³ãƒ¼ãƒ‰ã®è¦ç‚¹ã‚’è§£èª¬ã—ã¾ã™ã€‚

1. æ¨è«–ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã™ã«ã¯ã€å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã‚’TensorFlow Servingã®`PredictRequest`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
2. æ¨è«–ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰è¿”ã£ã¦ããŸ`PredictResponse`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ã€å¾Œç¶šå‡¦ç†ã®ãŸã‚ã«å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šå‡ºã—ã¾ã™ã€‚ã“ã“ã§ã¯Argmaxé–¢æ•°ã‚’ä½¿ã„ã¾ã™ã€‚
3. ãƒ•ã‚¡ã‚¤ãƒ«ã®`byte[]`ãƒ‡ãƒ¼ã‚¿ã‚’`PredictRequest`ã«å¤‰æ›ã—ã¾ã™ã€‚ã¾ãšãƒ‡ãƒ¼ã‚¿ã‚’é©åˆ‡ã«å‰å‡¦ç†ï¼ˆ`preprocess(body)`ï¼‰ã—ã€ãƒ‡ãƒ¼ã‚¿å‹ï¼ˆ`DT_FLOAT`ï¼‰ã¨æ¬¡å…ƒï¼ˆ`28x28`ï¼‰ã®ä¸€è‡´ã—ãŸ`TensorProto`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ãƒ©ãƒƒãƒ—ã—ã¾ã™ã€‚æœ€å¾Œã«ãã®`TensorProto`å…¥åŠ›ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ©ãƒ™ãƒ«`keras_tensor`ã§`PredictRequest`ã«ç™»éŒ²ã—ã¾ã™ã€‚TensorFlow Servingã§ãƒ¢ãƒ‡ãƒ«ã‚’å‘¼ã³å‡ºã™ã«ã¯ã“ã‚Œã‚‰ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’ã™ã¹ã¦æ­£ç¢ºã«è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€ã“ã‚Œã‚‰ã®æƒ…å ±ã¯ã™ã¹ã¦ãƒ¢ãƒ‡ãƒ«ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ã§ãã¾ã™ï¼ˆ[ãƒ¢ãƒ‡ãƒ«ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—](#ãƒ¢ãƒ‡ãƒ«ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—)ï¼‰ã€‚
4. ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã `byte[]`ãƒ‡ãƒ¼ã‚¿ã®å‰å‡¦ç†ã§ã™ã€‚ã“ã“ã§ã¯ã€28x28ã®RGBç”»åƒãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é’è‰²ã ã‘ã‚’æŠœãå‡ºã—ã€MNISTãƒ¢ãƒ‡ãƒ«ãŒæœŸå¾…ã™ã‚‹0ã€œ1ã®Floatå€¤ã«æ­£è¦åŒ–ã—ã¦ã„ã¾ã™ã€‚
5. Argmaxé–¢æ•°ã‚’æä¾›ã™ã‚‹æ‰‹è»½ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯Javaã«ã¯ãªã„ã®ã§ã€è‡ªåˆ†ã§å®Ÿè£…ã—ã¾ã™ã€‚`PredictResponse`ã‹ã‚‰å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã¨ãã®ãƒ©ãƒ™ãƒ«`output_0`ã‚‚ã€ãƒ¢ãƒ‡ãƒ«ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ã§ãã¾ã™ï¼ˆ[ãƒ¢ãƒ‡ãƒ«ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—](#ãƒ¢ãƒ‡ãƒ«ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—)ï¼‰ã€‚

ã•ã¦ã€ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€[ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿](https://github.com/pytorch/serve/tree/master/examples/image_classifier/mnist/test_data)ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã®`data/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸå¾Œã€Camel CLIã‹ã‚‰ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚

```console
camel run predict.java
```

æˆåŠŸã™ã‚Œã°ã€ä»¥ä¸‹ã®ã‚ˆã†ãªçµæœãŒå¾—ã‚‰ã‚Œã‚‹ã§ã—ã‚‡ã†ã€‚æ‰‹æ›¸ãã®æ•°å­—ãŒæ­£ã—ãèªè­˜ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

```console
8.png => 8
9.png => 9
4.png => 4
5.png => 5
7.png => 7
6.png => 6
2.png => 2
3.png => 3
1.png => 1
0.png => 0
```

### åˆ†é¡ï¼ˆClassifyï¼‰

æ¬¡ã«Classify APIã‚’ç´¹ä»‹ã—ã¾ã™ã€‚ã“ã®APIã¯ã€å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ç¾¤ã‚’ç‰¹å®šã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«åˆ†é¡ã™ã‚‹åˆ†é¡å•é¡Œã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚¹ãƒˆã‚’å…¥åŠ›ã¨ã—ã¦å—ã‘å–ã‚Šã€å„åˆ†é¡ãƒ©ãƒ™ãƒ«ã«ã‚¹ã‚³ã‚¢ã‚’ä»˜ã‘ãŸãƒªã‚¹ãƒˆã‚’å‡ºåŠ›ã¨ã—ã¦è¿”ã—ã¾ã™ã€‚

å…ˆã»ã©ã®MNISTãƒ¢ãƒ‡ãƒ«ã¯Classify APIã«å¯¾å¿œã—ã¦ã„ãªã„ã®ã§ã€ä»£ã‚ã‚Šã«ã‚‚ã†1ã¤ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸãƒ¢ãƒ‡ãƒ«`half_plus_two`ã‚’ç”¨ã„ã¾ã™ã€‚ã“ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ¢ãƒ‡ãƒ«ã¯éå¸¸ã«ç°¡å˜ãªãƒ¢ãƒ‡ãƒ«ã§ã€åå‰ã‹ã‚‰åˆ†ã‹ã‚‹ã‚ˆã†ã«å˜ã«å…¥åŠ›å€¤ $x$ ã«å¯¾ã—ã¦ã€

$$
\frac{x}{2} + 2
$$

ã‚’è¨ˆç®—ã—ã¦è¿”ã™ã ã‘ã§ã™ã€‚ç­”ãˆã¯ãƒ©ãƒ™ãƒ«ã®ãªã„å˜ä¸€ã®ã‚¹ã‚³ã‚¢ã¨ã—ã¦è¿”ã•ã‚Œã¾ã™ã€‚

![half_plus_two](https://storage.googleapis.com/zenn-user-upload/a972277ebd37-20250219.png)
*half_plus_two*

æ¨è«–ã«ã¯ä»¥ä¸‹ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ã„ã¾ã™ã€‚ã“ã®ãƒ¢ãƒ‡ãƒ«ã¯è¤‡æ•°ã®ã‚·ã‚°ãƒãƒãƒ£ã‚’æŒã£ã¦ã„ã‚‹ã®ã§ã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³`signatureName`ã§ã‚·ã‚°ãƒãƒãƒ£`classify_x_to_y`ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```uri
tensorflow-serving:classify?modelName=half_plus_two&modelVersion=123&signatureName=classify_x_to_y
```

```java:classify.java
//DEPS org.apache.camel:camel-bom:4.10.0@pom
//DEPS org.apache.camel:camel-core
//DEPS org.apache.camel:camel-tensorflow-serving

import org.apache.camel.builder.RouteBuilder;
import org.tensorflow.example.Example;
import org.tensorflow.example.Feature;
import org.tensorflow.example.Features;
import org.tensorflow.example.FloatList;
import tensorflow.serving.InputOuterClass.ExampleList;
import tensorflow.serving.InputOuterClass.Input;

public class classify extends RouteBuilder {
    @Override
    public void configure() throws Exception {
        from("timer:classify?repeatCount=1")
            .setBody(constant(createInput("x", 1.0f)))
            .to("tensorflow-serving:classify?modelName=half_plus_two&modelVersion=123&signatureName=classify_x_to_y")
            .log("Result: ${body.result}");
    }

    Input createInput(String key, float f) {  // (1)
        Feature feature = Feature.newBuilder()
                .setFloatList(FloatList.newBuilder().addValue(f))
                .build();
        Features features = Features.newBuilder()
                .putFeature(key, feature)
                .build();
        Example example = Example.newBuilder()
                .setFeatures(features)
                .build();
        ExampleList exampleList = ExampleList.newBuilder()
                .addExamples(example)
                .build();
        return Input.newBuilder()
                .setExampleList(exampleList)
                .build();
    }
}
```

Predict APIã®æ™‚ã¨åŒæ§˜ã€å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦`Input`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€

1. 1ã¤ã²ã¨ã¤ã®ç‰¹å¾´é‡ï¼ˆ`Feature`ï¼‰ã‚’ã¾ã¨ã‚ãŸï¼ˆ`Features`ï¼‰ã‚µãƒ³ãƒ—ãƒ«ï¼ˆ`Example`ï¼‰ã‚’ã•ã‚‰ã«ãƒªã‚¹ãƒˆï¼ˆ`ExampleList`ï¼‰ã«ã¾ã¨ã‚ã‚‹

ã ã‘ãªã®ã§ã€Predict APIã«æ¯”ã¹ã¦å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆãŒç°¡å˜ã§ã™ã€‚

Camel CLIã‹ã‚‰ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè¡Œã—ã¾ã™ã€‚

```console
camel run classify.java
```

æˆåŠŸã™ã‚Œã°ã€ä»¥ä¸‹ã®ã‚ˆã†ãªçµæœãŒå¾—ã‚‰ã‚Œã‚‹ã§ã—ã‚‡ã†ã€‚$\frac{1.0}{2} + 2 = 2.5$ã§ã™ã€‚

```console
Result: classifications {
  classes {
    score: 2.5
  }
}
```

### å›å¸°åˆ†æï¼ˆRegressï¼‰

æœ€å¾Œã«Regress APIã§ã™ã€‚ã“ã®APIã¯ã€å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®ç³»åˆ—ã‹ã‚‰ãã‚Œã‚‰ã®é–¢ä¿‚æ€§ã‚’äºˆæ¸¬ã™ã‚‹æ‰‹æ³•ã€å›å¸°åˆ†æã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚¹ãƒˆã‚’å…¥åŠ›ã¨ã—ã¦å—ã‘å–ã‚Šã€äºˆæ¸¬ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ç³»åˆ—ã®ãƒªã‚¹ãƒˆã‚’å‡ºåŠ›ã¨ã—ã¦è¿”ã—ã¾ã™ã€‚

å…ˆã»ã©ã¨åŒæ§˜ã€`half_plus_two`ãƒ¢ãƒ‡ãƒ«ã‚’ç”¨ã„ã¾ã™ã€‚

æ¨è«–ã«ã¯ä»¥ä¸‹ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ã„ã¾ã™ã€‚ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³`signatureName`ã§ã‚·ã‚°ãƒãƒãƒ£`regress_x_to_y`ã‚’æŒ‡å®šã—ã¾ã™ã€‚

```uri
tensorflow-serving:regress?modelName=half_plus_two&modelVersion=123&signatureName=regress_x_to_y
```

```java:regress.java
//DEPS org.apache.camel:camel-bom:4.10.0@pom
//DEPS org.apache.camel:camel-core
//DEPS org.apache.camel:camel-tensorflow-serving

import org.apache.camel.builder.RouteBuilder;
import org.tensorflow.example.Example;
import org.tensorflow.example.Feature;
import org.tensorflow.example.Features;
import org.tensorflow.example.FloatList;
import tensorflow.serving.InputOuterClass.ExampleList;
import tensorflow.serving.InputOuterClass.Input;

public class regress extends RouteBuilder {
    @Override
    public void configure() throws Exception {
        from("timer:regress?repeatCount=1")
            .setBody(constant(createInput("x", 1.0f)))
            .to("tensorflow-serving:regress?modelName=half_plus_two&modelVersion=123&signatureName=regress_x_to_y")
            .log("Result: ${body.result}");
    }

    Input createInput(String key, float f) {
        Feature feature = Feature.newBuilder()
                .setFloatList(FloatList.newBuilder().addValue(f))
                .build();
        Features features = Features.newBuilder()
                .putFeature(key, feature)
                .build();
        Example example = Example.newBuilder()
                .setFeatures(features)
                .build();
        ExampleList exampleList = ExampleList.newBuilder()
                .addExamples(example)
                .build();
        return Input.newBuilder()
                .setExampleList(exampleList)
                .build();
    }
}
```

Camel CLIã‹ã‚‰ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè¡Œã—ã¾ã™ã€‚

```console
camel run regress.java
```

æˆåŠŸã™ã‚Œã°ã€ä»¥ä¸‹ã®ã‚ˆã†ãªçµæœãŒå¾—ã‚‰ã‚Œã‚‹ã§ã—ã‚‡ã†ã€‚é€šå¸¸ã¯å€¤ã®ãƒªã‚¹ãƒˆãŒè¿”ã‚Šã¾ã™ãŒã€ã“ã®ãƒ¢ãƒ‡ãƒ«ã§ã¯1ã¤ã ã‘ã§ã™ã€‚$\frac{1.0}{2} + 2 = 2.5$ã§ã™ã€‚

```console
Result: regressions {
  value: 2.5
}
```

## ã¾ã¨ã‚

TorchServeã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«å¼•ãç¶šãã€æœ€æ–°ã®Camel 4.10.0 LTSãƒªãƒªãƒ¼ã‚¹ã§ä½¿ãˆã‚‹AIãƒ¢ãƒ‡ãƒ«ã‚µãƒ¼ãƒ“ãƒ³ã‚°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®1ã¤ã€TensorFlow Servingã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®æ©Ÿèƒ½ã‚’ä¸€é€šã‚Šè¦‹ã¦ãã¾ã—ãŸã€‚

TensorFlow Servingã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½¿ãˆã°ã€Camelã‚’ãƒ™ãƒ¼ã‚¹ã«æ§‹ç¯‰ã—ãŸã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«TensorFlowã§å­¦ç¿’ã—ãŸAIãƒ¢ãƒ‡ãƒ«ã‚’ç°¡å˜ã«å–ã‚Šå…¥ã‚Œã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚TensorFlowãƒ™ãƒ¼ã‚¹ã®å‰µé€ çš„ãªAIã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ ã®å¯èƒ½æ€§ãŒåºƒãŒã‚Šã¾ã™ã€‚

æ¬¡å›ã¯ã€æœ€å¾Œã«KServeã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

### ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰

ä»Šå›ç´¹ä»‹ã—ãŸCamelÃ—AIã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯ã€ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã§å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚

https://github.com/megacamelus/camel-ai-examples
